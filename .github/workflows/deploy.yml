name: Deploy to EC2

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch o tag a desplegar (ej. main o v1.0.0)"
        required: true
        default: "main"
  push:
    branches: [ main ]
    paths:
      - "app/**"
      - "requirements.txt"
      - "scripts/**"
      - "service/**"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}

      - name: Prepare SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_KEY }}" > ~/.ssh/sky2.pem
          chmod 600 ~/.ssh/sky2.pem
          # Conocemos la huella del host en tiempo de ejecución
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH connectivity
        run: |
          ssh -i ~/.ssh/sky2.pem -p ${{ secrets.EC2_PORT }} -o StrictHostKeyChecking=yes \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'SSH OK on '$(hostname)"

      - name: Create app dir on EC2
        run: |
          ssh -i ~/.ssh/sky2.pem -p ${{ secrets.EC2_PORT }} \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "mkdir -p ${{ secrets.APP_DIR }}"

      - name: Sync files to EC2
        run: |
          rsync -az --delete \
            --exclude='.git' \
            --exclude='.venv' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            -e "ssh -i ~/.ssh/sky2.pem -p ${{ secrets.EC2_PORT }} -o StrictHostKeyChecking=yes" \
            ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ secrets.APP_DIR }}/

      - name: Install deps & restart service
        run: |
          ssh -i ~/.ssh/sky2.pem -p ${{ secrets.EC2_PORT }} \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd "${APP_DIR}"

            # Crear venv si no existe
            if [ ! -d ".venv" ]; then
              python3 -m venv .venv
            fi

            # Activar venv e instalar dependencias
            source .venv/bin/activate
            python -m pip install --upgrade pip
            if [ -f requirements.txt ]; then
              pip install -r requirements.txt
            fi

            # Instalar unit file y reiniciar servicio
            if [ -f "service/${SERVICE_NAME}.service" ]; then
              sudo cp -f "service/${SERVICE_NAME}.service" "/etc/systemd/system/${SERVICE_NAME}.service"
              sudo systemctl daemon-reload
              sudo systemctl enable "${SERVICE_NAME}"
              sudo systemctl restart "${SERVICE_NAME}"
              sleep 3
              sudo systemctl status "${SERVICE_NAME}" --no-pager || true
            else
              echo "No se encontró service/${SERVICE_NAME}.service; omitiendo systemd."
            fi
          EOF
        env:
          APP_DIR: ${{ secrets.APP_DIR }}
          SERVICE_NAME: ${{ secrets.SERVICE_NAME }}
